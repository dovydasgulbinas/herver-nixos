#!/usr/bin/env bash

git_new_branch() {
  if [ -z "$1" ]; then
    echo "‚ùå Branch name required"
    echo "Usage: git_new_branch <new-branch-name>"
    return 1
  fi

  local NEW_BRANCH="$1"
  local BASE_BRANCH
  local REPO_ROOT
  local DEV_DOCS_DIR

  # Check if branch already exists locally
  if git show-ref --verify --quiet "refs/heads/$NEW_BRANCH"; then
    echo "‚ö†Ô∏è  Branch '$NEW_BRANCH' already exists. Nothing to do."
    return 0
  fi

  # Detect main / master
  if git show-ref --verify --quiet refs/heads/main; then
    BASE_BRANCH="main"
  elif git show-ref --verify --quiet refs/heads/master; then
    BASE_BRANCH="master"
  else
    echo "‚ùå Neither 'main' nor 'master' branch found"
    return 1
  fi

  # Find repo root
  REPO_ROOT=$(git rev-parse --show-toplevel) || {
    echo "‚ùå Not inside a git repository"
    return 1
  }

  DEV_DOCS_DIR="$REPO_ROOT/.devdocs/$NEW_BRANCH"

  set -e

  git checkout "$BASE_BRANCH"
  git pull origin "$BASE_BRANCH"
  git checkout -b "$NEW_BRANCH"

  mkdir -p "$DEV_DOCS_DIR"

  echo "‚úÖ Successfully created branch '$NEW_BRANCH' from '$BASE_BRANCH'"
  echo "üìÅ Dev docs directory created at: $DEV_DOCS_DIR"
}
alias new-task="git_new_branch"

# Fuzzy search through history
fzf-history-widget() {
  local selected
  selected=$(history -n -r 1 | fzf --tac +s --no-sort --height 40% --reverse --prompt="History> ") || return
  print -z "$selected"
}
zle -N fzf-history-widget
bindkey '^R' fzf-history-widget

makeqr() {
    if [[ -z "$1" ]]; then
        echo "Usage: makeqr <url>"
        return 1
    fi

    # Strip protocol, slashes, and dots
    local name
    name=$(echo "$1" | sed -E 's#https?://##; s#[/.]##g')

    qrencode -t SVG -s 10 -o "${name}.svg" "$1"
    qrencode -t PNG -s 10 -o "${name}.png" "$1"

    echo "Created: ${name}.svg and ${name}.png"
}

include () {
    [[ -f "$1" ]] && source "$1"
}



format_xml() {
    if [[ -z "$1" ]]; then
        echo "Usage: format_xml <file.xml>"
        return 1
    fi

    if [[ ! -f "$1" ]]; then
        echo "Error: File '$1' not found."
        return 1
    fi

    xmlstarlet fo -s 4 -o "$1" | sponge "$1"
}


wttr()
{
  curl 'wttr.in/Siauliai?format=v2'
}
wtts()
{
  curl "wttr.in/Siauliai?format=%l:+%c++%t,+üí¶++%h,+üö©++%w++%m"
}

moon(){
 curl wttr.in/Moon
}

joke() {
  JOKES=$(curl -s --max-time 2 "https://v2.jokeapi.dev/joke/Programming?blacklistFlags=nsfw,religious,political,racist,sexist,explicit&format=txt&type=single" || true)
  if [ "$JOKES" != "" ]; then
  echo -e "$JOKES\n"
  fi
}

del() {
    mkdir -p ~/.Trash
    local F
    for F; do
        mv -- "$F" ~/.Trash/"$F-$(exec date '+%F-%T')"
    done
}
